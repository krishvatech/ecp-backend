<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ECP Backend ‚Äî API Test UI</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --accent:#22c55e; --error:#ef4444; --border:#1f2937; }
    * { box-sizing: border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:#e5e7eb; }
    header{ padding:18px 20px; border-bottom:1px solid var(--border); position:sticky; top:0; background:linear-gradient(0deg, rgba(15,23,42,.94), rgba(15,23,42,.94)); backdrop-filter: blur(6px);}
    h1{ font-size:18px; margin:0; letter-spacing: .3px; }
    main{ display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px; }
    .col{ display:flex; flex-direction:column; gap:16px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .card h2{ font-size:14px; margin:2px 0 12px; color:#cbd5e1; letter-spacing:.2px; }
    label{ font-size:12px; color: var(--muted); display:block; margin:10px 0 6px; }
    input, select, textarea{ width:100%; background:#0b1220; border:1px solid var(--border); color:#e5e7eb; border-radius:10px; padding:10px 12px; outline:none; }
    input:focus, textarea:focus, select:focus{ border-color:#334155; }
    .row{ display:flex; gap:8px; align-items:center; }
    .row > *{ flex:1; }
    button{ background:#1f2937; border:1px solid var(--border); color:#e5e7eb; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button.primary{ background:var(--accent); border-color:#16a34a; color:#072a12; font-weight:700; }
    button.warn{ background:#334155; border-color:#475569; }
    button.danger{ background:#3b0d0d; border-color:#7f1d1d; color:#fecaca; }
    .muted{ color: var(--muted); font-size:12px; }
    .status{ font-size:12px; margin-top:8px; }
    .status.ok{ color: var(--accent); }
    .status.err{ color: var(--error); }
    pre{ background:#0b1220; border:1px solid var(--border); padding:12px; border-radius:12px; overflow:auto; max-height:300px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; background:#0b1220; border:1px solid var(--border); font-size:12px; }
    .footer{ padding:12px 16px; color:var(--muted); font-size:12px; border-top:1px solid var(--border); text-align:center; }
    a { color:#93c5fd; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <h1>üß™ ECP Backend ‚Äî API Test UI</h1>
  </header>

  <main>
    <!-- LEFT COLUMN: Controls -->
    <div class="col">
      <div class="card" id="serverCard">
        <h2>Server</h2>
        <label>Base URL</label>
        <input id="baseUrl" value="http://127.0.0.1:8000" />
        <div class="row">
          <button onclick="ping()">Ping</button>
          <button class="warn" onclick="openSwagger()">Open Swagger</button>
        </div>
        <div id="serverStatus" class="status muted">Ready</div>
      </div>

      <div class="card">
        <h2>Auth ‚Äî Register</h2>
        <label>Email</label>
        <input id="regEmail" placeholder="you@example.com" />
        <label>Password</label>
        <input id="regPassword" type="password" placeholder="min 8 chars" />
        <div class="grid-2">
          <div>
            <label>First name</label>
            <input id="regFirst" placeholder="(optional)" />
          </div>
          <div>
            <label>Last name</label>
            <input id="regLast" placeholder="(optional)" />
          </div>
        </div>
        <label>Full name (profile)</label>
        <input id="regFull" placeholder="(optional) e.g., Alex Patel" />
        <button class="primary" onclick="registerUser()">Create account</button>
        <pre id="registerOut"></pre>
      </div>

      <div class="card">
        <h2>Auth ‚Äî Login (JWT)</h2>
        <label>Email</label>
        <input id="loginEmail" placeholder="you@example.com" />
        <label>Password</label>
        <input id="loginPassword" type="password" />
        <div class="row">
          <button class="primary" onclick="loginUser()">Login</button>
          <button class="warn" onclick="refreshToken()">Refresh</button>
          <button class="danger" onclick="clearTokens()">Clear tokens</button>
        </div>
        <div class="row">
          <span class="pill">Access: <span id="accessShort">‚Äî</span></span>
          <span class="pill">Refresh: <span id="refreshShort">‚Äî</span></span>
        </div>
        <pre id="loginOut"></pre>
      </div>

      <div class="card">
        <h2>Auth ‚Äî Sign in with LinkedIn</h2>
        <p class="muted">Starts the OAuth flow by requesting <code>/api/auth/linkedin/url/</code> and redirecting the browser.</p>
        <div class="row">
          <button class="primary" onclick="startLinkedIn()">Continue with LinkedIn</button>
          <button class="warn" onclick="captureTokensFromURL()">Capture tokens from URL</button>
        </div>
        <pre id="linkedinOut"></pre>
        <p class="muted">Tip: If your backend callback redirects back here with <code>?access=...&refresh=...</code>, click ‚ÄúCapture tokens from URL‚Äù.</p>
      </div>

      <div class="card">
        <h2>Me</h2>
        <div class="row">
          <button onclick="getMe()">GET /api/users/me/</button>
          <button onclick="updateMe()">PUT /api/users/me/</button>
        </div>
        <label>Update full name</label>
        <input id="meFull" placeholder="e.g., Alex P." />
        <pre id="meOut"></pre>
      </div>
    </div>

    <!-- RIGHT COLUMN: Domain APIs -->
    <div class="col">
      <div class="card">
        <h2>Organizations</h2>
        <div class="row">
          <button onclick="listOrgs()">List (GET /api/organizations/)</button>
        </div>
        <div class="row">
          <input id="orgName" placeholder="Org name" />
          <button class="primary" onclick="createOrg()">Create (POST)</button>
        </div>
        <pre id="orgOut"></pre>
      </div>

      <div class="card">
        <h2>Events</h2>
        <div class="row">
          <button onclick="listEvents()">List (GET /api/events/)</button>
        </div>
        <div class="grid-2">
          <div>
            <label>Organization ID</label>
            <input id="evOrgId" placeholder="e.g., 1" />
          </div>
          <div>
            <label>Title</label>
            <input id="evTitle" placeholder="Demo Event" />
          </div>
        </div>
        <button class="primary" onclick="createEvent()">Create (POST)</button>
        <hr style="border-color:var(--border); margin:14px 0;">
        <div class="grid-2">
          <div>
            <label>Event ID</label>
            <input id="evId" placeholder="e.g., 1" />
          </div>
          <div>
            <label>Stream Role</label>
            <select id="evRole">
              <option value="publisher">publisher (host)</option>
              <option value="subscriber">subscriber (viewer)</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button onclick="getEvent()">GET /api/events/{id}/</button>
          <button class="primary" onclick="getStreamToken()">POST /api/events/{id}/token/</button>
        </div>
        <pre id="eventOut"></pre>
      </div>

      <div class="card">
        <h2>Raw Request</h2>
        <p class="muted">Fire any request against your API (JWT added automatically if present).</p>
        <label>Method & Path</label>
        <div class="row">
          <select id="rawMethod">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>PATCH</option>
            <option>DELETE</option>
          </select>
          <input id="rawPath" value="/api/events/" />
        </div>
        <label>JSON Body</label>
        <textarea id="rawBody" rows="6">{}</textarea>
        <div class="row">
          <button onclick="sendRaw()">Send</button>
          <button class="warn" onclick="copyLastResponse()">Copy last response</button>
        </div>
        <pre id="rawOut"></pre>
      </div>
    </div>
  </main>

  <div class="footer">ECP Test UI ‚Ä¢ Handy harness for your Django APIs</div>

  <script>
    // ================= Helpers =================
    const $ = (id) => document.getElementById(id);
    const j = (v) => JSON.stringify(v, null, 2);

    function base() {
      let url = $("baseUrl").value.trim().replace(/\/$/, "");
      return url || "http://127.0.0.1:8000";
    }

    function setStatus(el, ok, msg){
      el.className = "status " + (ok?"ok":"err");
      el.textContent = msg;
    }

    function short(token){
      if(!token) return "‚Äî";
      return token.slice(0,12) + "‚Ä¶" + token.slice(-6);
    }

    function saveTokens({access, refresh}){
      if(access) localStorage.setItem("access", access);
      if(refresh) localStorage.setItem("refresh", refresh);
      $("accessShort").textContent = short(localStorage.getItem("access"));
      $("refreshShort").textContent = short(localStorage.getItem("refresh"));
    }

    function clearTokens(){
      localStorage.removeItem("access");
      localStorage.removeItem("refresh");
      saveTokens({access:null, refresh:null});
      $("loginOut").textContent = "(cleared)";
    }

    async function api(method, path, body){
      const url = base() + path;
      const headers = { "Content-Type": "application/json" };
      const access = localStorage.getItem("access");
      if(access) headers["Authorization"] = `Bearer ${access}`;
      const res = await fetch(url, { method, headers, body: body?JSON.stringify(body):undefined });
      const text = await res.text();
      let data;
      try { data = text? JSON.parse(text) : {}; } catch { data = { raw:text }; }
      if(!res.ok){ throw { status:res.status, data }; }
      return data;
    }

    // Capture tokens from query string (optional pattern: ?access=..&refresh=..)
    function captureTokensFromURL(){
      const p = new URLSearchParams(location.search);
      const access = p.get("access");
      const refresh = p.get("refresh");
      if(access || refresh){
        saveTokens({access, refresh});
        history.replaceState({}, "", location.pathname); // clean URL
        $("linkedinOut").textContent = j({saved:true, access: short(access), refresh: short(refresh)});
      } else {
        $("linkedinOut").textContent = "No tokens present in URL params.";
      }
    }

    // ================= Server =================
    async function ping(){
      try{
        const res = await fetch(base()+"/", {method:"GET"});
        setStatus($("serverStatus"), res.ok, `GET / ‚Üí ${res.status}`);
      }catch(err){
        setStatus($("serverStatus"), false, `Ping failed: ${err}`);
      }
    }
    function openSwagger(){ window.open(base()+"/api/docs/", "_blank"); }

    // ================= Register/Login =================
    async function registerUser(){
      const body = {
        email: $("regEmail").value.trim(),
        password: $("regPassword").value,
        first_name: $("regFirst").value.trim() || undefined,
        last_name: $("regLast").value.trim() || undefined,
        profile: { full_name: $("regFull").value.trim() || undefined }
      };
      try{
        const out = await api("POST", "/api/auth/register/", body);
        $("registerOut").textContent = j(out);
      }catch(e){ $("registerOut").textContent = j(e); }
    }

    async function loginUser(){
      const body = { email: $("loginEmail").value.trim(), password: $("loginPassword").value };
      try{
        const out = await api("POST", "/api/auth/token/", body);
        saveTokens(out);
        $("loginOut").textContent = j(out);
      }catch(e){ $("loginOut").textContent = j(e); }
    }

    async function refreshToken(){
      const refresh = localStorage.getItem("refresh");
      if(!refresh){ $("loginOut").textContent = "No refresh token"; return; }
      try{
        const out = await api("POST", "/api/auth/token/refresh/", { refresh });
        saveTokens(out);
        $("loginOut").textContent = j(out);
      }catch(e){ $("loginOut").textContent = j(e); }
    }

    // ================= LinkedIn =================
    async function startLinkedIn(){
      try{
        const out = await api("GET", "/api/auth/linkedin/url/");
        $("linkedinOut").textContent = j(out);
        if(out && out.authorization_url){
          window.location = out.authorization_url; // start OAuth
        }
      }catch(e){ $("linkedinOut").textContent = j(e); }
    }

    // ================= Me =================
    async function getMe(){
      try{ $("meOut").textContent = j(await api("GET", "/api/users/me/")); }
      catch(e){ $("meOut").textContent = j(e); }
    }
    async function updateMe(){
      const full = $("meFull").value.trim();
      const body = full ? { profile: { full_name: full } } : {};
      try{ $("meOut").textContent = j(await api("PUT", "/api/users/me/", body)); }
      catch(e){ $("meOut").textContent = j(e); }
    }

    // ================= Orgs =================
    async function listOrgs(){
      try{ $("orgOut").textContent = j(await api("GET", "/api/organizations/")); }
      catch(e){ $("orgOut").textContent = j(e); }
    }
    async function createOrg(){
      const name = $("orgName").value.trim();
      if(!name){ $("orgOut").textContent = "Enter organization name"; return; }
      try{ $("orgOut").textContent = j(await api("POST", "/api/organizations/", { name })); }
      catch(e){ $("orgOut").textContent = j(e); }
    }

    // ================= Events =================
    async function listEvents(){
      try{ $("eventOut").textContent = j(await api("GET", "/api/events/")); }
      catch(e){ $("eventOut").textContent = j(e); }
    }
    async function createEvent(){
      const organization = parseInt($("evOrgId").value, 10);
      const title = $("evTitle").value.trim();
      if(!organization || !title){ $("eventOut").textContent = "Provide organization id & title"; return; }
      try{ $("eventOut").textContent = j(await api("POST", "/api/events/", { organization, title })); }
      catch(e){ $("eventOut").textContent = j(e); }
    }
    async function getEvent(){
      const id = $("evId").value.trim();
      if(!id){ $("eventOut").textContent = "Enter Event ID"; return; }
      try{ $("eventOut").textContent = j(await api("GET", `/api/events/${id}/`)); }
      catch(e){ $("eventOut").textContent = j(e); }
    }
    async function getStreamToken(){
      const id = $("evId").value.trim();
      const role = $("evRole").value;
      if(!id){ $("eventOut").textContent = "Enter Event ID"; return; }
      try{ $("eventOut").textContent = j(await api("POST", `/api/events/${id}/token/`, { role })); }
      catch(e){ $("eventOut").textContent = j(e); }
    }

    // ================= Raw =================
    let lastResponseForCopy = "";
    async function sendRaw(){
      const method = $("rawMethod").value;
      const path = $("rawPath").value.trim();
      const bodyText = $("rawBody").value.trim();
      let body = undefined;
      try{ body = bodyText ? JSON.parse(bodyText) : undefined; } catch { /* keep undefined */ }
      try{
        const out = await api(method, path, body);
        $("rawOut").textContent = j(out);
        lastResponseForCopy = $("rawOut").textContent;
      }catch(e){ $("rawOut").textContent = j(e); lastResponseForCopy = $("rawOut").textContent; }
    }
    function copyLastResponse(){
      if(!lastResponseForCopy){ return; }
      navigator.clipboard.writeText(lastResponseForCopy);
    }

    // Init on load
    (function init(){
      saveTokens({access: localStorage.getItem("access"), refresh: localStorage.getItem("refresh")});
      // auto-capture tokens if present in URL (?access=&refresh=)
      captureTokensFromURL();
    })();
  </script>
</body>
</html>